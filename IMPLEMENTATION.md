## Implementation Details

This document describes the implementation details and architecture of the steamutils package.

CAUTION: This code was generated by an LLM. It has not been thoroughly tested or verified for production use. Please use with caution and verify behavior in your specific use case before deployment.

### Project Structure

- steam.go: Core SteamReader implementation and main API
- steam_windows.go: Windows-specific path detection via registry
- steam_linux.go: Linux-specific path detection and Steam registry fallback
- steam_darwin.go: macOS-specific path detection
- appmanifest.go: Application manifest reading and parsing
- vdf.go: Valve Data Format (VDF) parser
- define.go: Type definitions

### VDF Format Parser

The VDF format is a key-value data structure used by Valve applications. The implementation uses:

- parseString: Extracts quoted string values
- parseVDFOrdered: Recursively parses VDF structure into OrderedMaps
- marshalOrderedVDF: Converts OrderedMaps back to VDF text format
- Unmarshal: Main entry point for parsing VDF data

The parser preserves key ordering using the github.com/iancoleman/orderedmap package.

Implementation notes:

- Currently does not handle VDF escape sequences except for doubled backslashes
- Assumes well-formed input (unmatched braces may produce unexpected results)
- Recursive depth is unbounded (potential for stack overflow with deeply nested structures)
- No validation of VDF syntax beyond basic parsing

### Steam Path Detection

Platform-specific detection is implemented in separate files:

windows.go: Uses Windows Registry (HKEY_CURRENT_USER\Software\Valve\Steam\SteamPath)
linux.go: Checks multiple paths including standard locations, Flatpak, and Snap installations
darwin.go: Checks ~/Library/Application Support/Steam and other macOS locations

Each platform falls back to environment variable STEAM_PATH if configured.

### Application Manifest Format

Application manifests are stored as VDF files in steamapps/appmanifest_<appID>.acf

The manifest contains:

- AppState section with metadata
- appid: Application identifier
- name: Display name
- buildid: Build version
- installdir: Installation directory (relative)
- SizeOnDisk: Total installed size
- LastUpdated: Last update timestamp
- LastPlayed: Last play timestamp
- InstalledDepots: Section containing depot information
  - Each depot has manifest ID, size, and optional dlcappid

The readAppManifest function extracts this information and constructs full paths.

### Library Configuration

Steam maintains libraryfolders.vdf in the main Steam directory that lists all configured library locations.

Format:

"libraryfolders"
{
  "0"
  {
    "path" "C:\\Program Files\\Steam"
    "label" ""
    "contentid" "1234567890"
    "totalsize" "0"
    "apps"
    {
      "667970" "3606612198"
      ...
    }
  }
  ...
}

The GetAllInstalledApps method reads this file and iterates through all apps in all libraries.

### Cross-Platform Considerations

Path handling differs by platform:

Windows: Uses backslashes, drives (C:\), case-insensitive paths
Linux: Uses forward slashes, no drive letters, case-sensitive paths
macOS: Uses forward slashes, relative to home directory, case-insensitive filesystem

The package attempts to normalize paths but may not handle all edge cases correctly.

GetSteamPath function applies formatting when FormatSteamPath is enabled:
- Uppercase drive letter (Windows)
- Proper case for "Program Files (x86)" (Windows)
- Uppercase "Steam" directory name
- Trailing backslash (Windows) or forward slash (Unix)

### Error Handling

The package returns error types for these common scenarios:

- fmt.Errorf for parsing and file I/O errors
- io errors wrapped with %w verb
- Custom error messages describe the failure condition

Not all error conditions are explicitly handled (e.g., registry access errors on Windows may be masked).

### Performance Notes

GetAllInstalledApps iterates through all libraries and reads manifest files sequentially. With large libraries, this may be slow:

- No caching is performed
- No concurrent I/O
- No index or database of apps
- Full VDF parsing happens each time

For repeated queries on the same Steam installation, consider caching the SteamReader instance.

### Known Limitations

1. VDF parser does not handle all escape sequences
2. Registry access on Windows may fail silently
3. No support for custom Steam install scripts
4. Symlinks followed but may produce unexpected results
5. File permissions issues not explicitly handled
6. No cleanup of temp files or resources
7. Timestamps are Unix epoch (may overflow in year 2038)

### Testing

The package includes unit tests for:

- VDF parsing (roundtrip marshaling)
- Application manifest reading
- Path detection (mocked)
- Library folder navigation
- Depot information extraction

Integration tests require Steam to be installed. Most tests use temp files and mocked data.

### Future Improvements

Potential enhancements (not currently implemented):

- Caching layer for manifest data
- Concurrent manifest reading
- Streaming VDF parser for large files
- Better error messages with context
- Support for custom manifest locations
- Registry caching on Windows
- Symlink cycle detection
